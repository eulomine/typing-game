<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì„¤êµ ë‹¨ì–´ íƒ€ì ê²Œì„</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #020617;
      color: #e5e7eb;
      display: flex;
      justify-content: center;
      padding: 16px;
      min-height: 100vh;
    }

    .wrapper {
      width: 900px;
      max-width: 100%;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    h1 {
      font-size: 22px;
      text-align: center;
      margin-bottom: 4px;
    }

    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      justify-content: center;
      font-size: 13px;
    }

    .difficulty-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    button {
      border: none;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      background: #334155;
      color: #e5e7eb;
    }

    button:hover {
      background: #475569;
    }

    button.active {
      background: #10b981;
      color: #022c22;
      font-weight: 600;
    }

    #startBtn {
      background: #3b82f6;
    }
    #startBtn:hover {
      background: #2563eb;
    }

    #fullscreenBtn {
      background: #6b7280;
    }

    .stats {
      display: flex;
      gap: 10px;
      align-items: center;
      font-size: 13px;
    }

    .hearts {
      font-size: 16px;
    }

    .game-container {
      position: relative;
      width: 100%;
      aspect-ratio: 16 / 10;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 15px 40px rgba(0,0,0,0.7);
      background: #000;
    }

    .bg-img {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none;
    }

    .overlay-dark {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at top, rgba(0,0,0,0.25), rgba(0,0,0,0.55));
      pointer-events: none;
    }

    .word {
      position: absolute;
      left: 0;
      top: 0;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.8);
      color: #f9fafb;
      font-size: 14px;
      white-space: nowrap;
      pointer-events: none;
      box-shadow: 0 3px 10px rgba(0,0,0,0.6);
      text-shadow:
        -1px -1px 0 #000,
        1px -1px 0 #000,
        -1px 1px 0 #000,
        1px 1px 0 #000;
    }

    .word.special {
      background: rgba(202, 138, 4, 0.92);
    }

    .flash {
      position: absolute;
      inset: 0;
      background: radial-gradient(circle, rgba(255,255,255,0.9), rgba(255,255,255,0));
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.25s ease;
    }

    .flash.show {
      opacity: 1;
    }

    .bottom-ui {
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 13px;
    }

    .input-row {
      display: flex;
      gap: 6px;
    }

    #typeInput {
      flex: 1;
      padding: 8px 10px;
      border-radius: 999px;
      border: none;
      font-size: 14px;
      outline: none;
    }

    #typeInput:focus {
      box-shadow: 0 0 0 2px #3b82f6;
    }

    #message {
      min-height: 18px;
      color: #9ca3af;
    }

    .panels {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      font-size: 12px;
    }

    .panel {
      flex: 1;
      min-width: 220px;
      background: #020617;
      border-radius: 10px;
      padding: 8px;
      border: 1px solid #1f2937;
    }

    .panel h2 {
      font-size: 13px;
      margin-bottom: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 12px;
    }

    th, td {
      padding: 2px 4px;
      text-align: left;
    }

    th {
      border-bottom: 1px solid #1f2937;
      color: #9ca3af;
    }

    tr:nth-child(even) td {
      background: #020617;
    }

    .rank-reset-btn {
      margin-top: 4px;
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 6px;
      background: #4b5563;
    }

    .countdown {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 72px;
      font-weight: 700;
      color: #facc15;
      text-shadow:
        0 0 10px #000,
        0 0 25px #000;
      pointer-events: none;
    }

    .hidden {
      display: none;
    }

    .game-over-modal {
      position: absolute;
      inset: 0;
      background: rgba(0,0,0,0.75);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }

    .game-over-box {
      background: #020617;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid #4b5563;
      width: 260px;
      text-align: center;
      font-size: 13px;
    }

    .game-over-box h2 {
      font-size: 18px;
      margin-bottom: 6px;
    }

    .game-over-box input {
      width: 100%;
      margin: 6px 0;
      padding: 6px 8px;
      border-radius: 8px;
      border: none;
      outline: none;
    }

    .game-over-box button {
      margin-top: 6px;
      width: 100%;
    }

    @media (max-width: 600px) {
      h1 {
        font-size: 18px;
      }
      .word {
        font-size: 12px;
      }
    }
  </style>
</head>
<body>
<div class="wrapper" id="gameWrapper">
  <h1>ì„¤êµ ë‹¨ì–´ íƒ€ì ê²Œì„</h1>

  <div class="top-bar">
    <span>ë‚œì´ë„:</span>
    <div class="difficulty-buttons" id="difficultyButtons">
      <button data-diff="kids" class="active">ìœ ë…„ê¿ˆí„°</button>
      <button data-diff="elem">ì´ˆë“±ê¿ˆí„°</button>
      <button data-diff="junior">ì†Œë…„ê¿ˆí„°</button>
      <button data-diff="youth">ì²­ì†Œë…„ë¶€</button>
      <button data-diff="adult">êµêµ¬êµ­</button>
    </div>
    <button id="startBtn">ê²Œì„ ì‹œì‘</button>
    <button id="fullscreenBtn" title="F í‚¤ë¡œë„ ì „ì²´í™”ë©´ ì „í™˜">ì „ì²´í™”ë©´</button>
    <div class="stats">
      <span>ì ìˆ˜: <strong id="score">0</strong></span>
      <span>ì‹¤ìˆ˜: <strong id="mistakes">0</strong></span>
      <span>ìƒëª…: <span class="hearts" id="hearts">â™¥â™¥â™¥</span></span>
    </div>
  </div>

  <div class="game-container" id="gameContainer">
    <!-- ë°°ê²½ ì´ë¯¸ì§€ëŠ” ê°™ì€ í´ë”ì— 'ëª©ì‚¬ë‹˜ë°°ê²½.jpg' ë¡œ ë‘ê¸° -->
    <img src="https://postfiles.pstatic.net/MjAyNTExMjVfMjI0/MDAxNzY0MDYwMzA4MzQ0.JjCmnDvzUyZf9rmuWCGbiiMs959uAS4t_7mW2W-8NZMg.XYeR2mRQev0YQ8FOpig9AhqXkq1FgZJAsJLhxgHXWOYg.JPEG/background-church.jpg?type=w580" alt="ëª©ì‚¬ë‹˜ ë°°ê²½" class="bg-img" />
    <div class="overlay-dark"></div>
    <div class="flash" id="flash"></div>
    <div class="countdown hidden" id="countdown"></div>
  </div>

  <div class="bottom-ui">
    <div class="input-row">
      <input id="typeInput"
             type="text"
             placeholder="ì—¬ê¸°ì— ë‹¨ì–´ë¥¼ ì…ë ¥í•˜ê³  Enter ë¥¼ ëˆ„ë¥´ì„¸ìš”"
             autocomplete="off" />
    </div>
    <div id="message"></div>

    <div class="panels">
      <div class="panel">
        <h2>ì„¤ëª…</h2>
        <p>ëª©ì‚¬ë‹˜ ì…ì—ì„œ ë‚˜ì˜¤ëŠ” ë§ì”€ì„ ê·¸ëŒ€ë¡œ ë”°ë¼ ì¹˜ì„¸ìš”. ë‹¨ì–´ë¥¼ ë†“ì¹˜ê±°ë‚˜ í‹€ë¦´ ë•Œë§ˆë‹¤ ìƒëª… -1, ìƒëª…ì´ 0ì´ ë˜ë©´ ê²Œì„ì´ ëë‚©ë‹ˆë‹¤.</p>
        <p>ì²­ì†Œë…„ë¶€ / êµêµ¬êµ­ì—ì„œëŠ” 10ê°œ ì¤‘ 1ê°œëŠ” <strong>êµ¬(ë‘Â·ì„¸ ì–´ì ˆ)</strong>ê°€ ë‚˜ì˜¤ë©°, ì„¸ ì–´ì ˆì§œë¦¬ íŠ¹ìˆ˜ êµ¬ë¥¼ ì •í™•íˆ ì¹˜ë©´ í™”ë©´ì´ ë°˜ì§ì´ê³  ëª¨ë“  ë‹¨ì–´ê°€ ì‚¬ë¼ì§€ë©° ìƒëª…ì´ +1 íšŒë³µë©ë‹ˆë‹¤.</p>
        <p>F í‚¤ë¥¼ ëˆŒëŸ¬ ì „ì²´í™”ë©´ ì „í™˜ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
      </div>
      <div class="panel">
        <h2>ë¡œì»¬ ë­í‚¹ (TOP 10)</h2>
        <table id="rankTable">
          <thead>
          <tr>
            <th>ìˆœìœ„</th>
            <th>ì´ë¦„</th>
            <th>ì ìˆ˜</th>
            <th>ë‚œì´ë„</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button class="rank-reset-btn" id="resetRankBtn">ë­í‚¹ ì´ˆê¸°í™”</button>
      </div>
    </div>
  </div>
</div>

<script>
  /***** ë‹¨ì–´ / êµ¬ ê·¸ë£¹ â€“ ì—¬ê¸° ë°°ì—´ë§Œ ë‚˜ì¤‘ì— ë§ˆìŒê» ìˆ˜ì •í•˜ë©´ ë¨ *****/
  const WORDS_KIDS = [
    "í•˜ë‚˜ë‹˜","ë…¸ì•„","ì•„ë¡ ","ë§Œë‚˜","ì¼ì–´ë‚˜ë¼","ì–´ë¦°ì´","ë‚˜ë¼",
    "í•˜ë§Œ","ë…¸ì¸","ë§ˆë¦¬ì•„","ë‚˜í™€","ë¯¸ë¦¬ì•”","ë§ˆë¼","ì•„ì´","ì¼ì–´ë‚˜ë¼"
  ];
  const WORDS_ELEM = [
    "ìš©ì„œ","êµ¬ì›","ê°ì‚¬","ì„±í™”","ì¸ë‚´","ìˆœì¢…","ì°¬ì–‘",
    "ë³µìŒ","ì œì","ê·¸ë¦¬ìŠ¤ë„","ì²œêµ­","ì‹­ìê°€","ì€ì‚¬","ì†Œëª…","ì¶•ë³µ"
  ];
  const WORDS_GENERAL = [
    "ìƒëª…","ì„±í™”","ì¤‘ë³´ê¸°ë„","ì§€í˜œ","ê±°ë£©í•¨",
    "ê¸íœ¼","ì˜ˆìˆ˜ë‹˜","ê¸°ì¨","ê²¸ì†","íšŒê°œ",
    "ì‚¬ëª…","ì˜ˆë°°","ë§ì”€ë¬µìƒ","ì„±ë ¹ì¶©ë§Œ"
  ];
  const PHRASES2 = [
    "ë¯¿ìŒì˜ ë°©íŒ¨",
    "ì‰¬ì§€ë§ê³  ê¸°ë„í•˜ë¼",
    "ì„±ë ¹ì˜ ê²€",
    "ì‚¬ë‘ì€ ì˜¤ë˜ì°¸ê³ ",
    "ê¸°ë„ì˜ ì‚¬ëŒ",
    "í•˜ë‚˜ë‹˜ì˜ ë‚˜ë¼",
    "ì„±ë ¹ì˜ ëŠ¥ë ¥",
    "í•­ìƒ ê¸°ë»í•˜ë¼"
  ];
  const PHRASES3 = [
    "ë¯¿ìŒ ì†Œë§ ì‚¬ë‘",
    "ë‘ë ¤ì›Œí•˜ì§€ ë§ë¼",
    "ì²œì§€ë¥¼ ì°½ì¡°í•˜ì‹  í•˜ë‚˜ë‹˜",
    "í•­ìƒ ê¸°ë»í•˜ë¼",
    "ì—¬í˜¸ì™€ëŠ” ë‚˜ì˜ ëª©ìì‹œë‹ˆ",
    "í•˜ë‚˜ë‹˜ê»˜ì„œ ì„¸ìƒì„ ì‚¬ë‘í•˜ì‚¬"
  ];
  const SPECIAL_3_SET = new Set(PHRASES3);

  /***** ë‚œì´ë„ ì„¤ì • *****/
  const DIFFICULTIES = {
    kids: {
      label: "ìœ ë…„ê¿ˆí„°",
      spawnInterval: 4000,
      fallDuration: 6000,
      wordPool: () => WORDS_KIDS,
      usePhrases2: false,
      usePhrases3: false
    },
    elem: {
      label: "ì´ˆë“±ê¿ˆí„°",
      spawnInterval: 3000,
      fallDuration: 5000,
      wordPool: () => WORDS_KIDS.concat(WORDS_ELEM),
      usePhrases2: false,
      usePhrases3: false
    },
    junior: {
      label: "ì†Œë…„ê¿ˆí„°",
      spawnInterval: 3000,
      fallDuration: 4000,
      wordPool: () => WORDS_KIDS.concat(WORDS_ELEM, WORDS_GENERAL),
      usePhrases2: true,
      usePhrases3: false
    },
    youth: {
      label: "ì²­ì†Œë…„ë¶€",
      spawnInterval: 1500,
      fallDuration: 3500,
      wordPool: () => WORDS_KIDS.concat(WORDS_ELEM, WORDS_GENERAL),
      usePhrases2: true,
      usePhrases3: true,
      special3Chance: 0.35
    },
    adult: {
      label: "êµêµ¬êµ­",
      spawnInterval: 1000,
      fallDuration: 3500,
      wordPool: () => WORDS_KIDS.concat(WORDS_ELEM, WORDS_GENERAL),
      usePhrases2: true,
      usePhrases3: true,
      special3Chance: 0.35
    }
  };

  /***** ì… ìœ„ì¹˜ â€“ 1024x1024 ê¸°ì¤€ (523, 480) â†’ ë¹„ìœ¨ *****/
  const MOUTH_X_RATIO = 523 / 1024; // â‰’ 0.5107
  const MOUTH_Y_RATIO = 450 / 1024; // â‰’ 0.4296

  // POP ì—°ì¶œìš© ìƒìˆ˜ (ìœ„ë¡œ íŠ€ëŠ” ëª¨ì…˜)
  const POP_TIME = 300;      // ìœ„ë¡œ íŠ€ëŠ” ì‹œê°„(ms)
  const POP_HEIGHT = 60;     // ìœ„ë¡œ ì˜¬ë¼ê°€ëŠ” ë†’ì´(px)

  /***** DOM *****/
  const gameWrapper = document.getElementById("gameWrapper");
  const gameContainer = document.getElementById("gameContainer");
  const startBtn = document.getElementById("startBtn");
  const fullscreenBtn = document.getElementById("fullscreenBtn");
  const typeInput = document.getElementById("typeInput");
  const messageEl = document.getElementById("message");
  const scoreEl = document.getElementById("score");
  const mistakesEl = document.getElementById("mistakes");
  const heartsEl = document.getElementById("hearts");
  const diffButtons = document.querySelectorAll("#difficultyButtons button");
  const countdownEl = document.getElementById("countdown");
  const flashEl = document.getElementById("flash");
  const rankTableBody = document.querySelector("#rankTable tbody");
  const resetRankBtn = document.getElementById("resetRankBtn");

  /***** ìƒíƒœ *****/
  let currentDiffKey = "kids";
  let running = false;
  let score = 0;
  let mistakes = 0;
  let lives = 3;
  let activeWords = [];
  let lastSpawnTime = 0;
  let lastFrameTime = 0;
  let totalSpawned = 0;
  let phraseSlotCounter = 0; // 0~9, 10ê°œ ì¤‘ 1ê°œ êµ¬
  let animationId = null;
  let countdownTimer = null;
  let pauseUntil = 0;
  let combo = 0;
  const MAX_LIVES = 3;

  /***** ë‚œì´ë„ ë²„íŠ¼ *****/
  diffButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      if (running) return;
      diffButtons.forEach(b => b.classList.remove("active"));
      btn.classList.add("active");
      currentDiffKey = btn.dataset.diff;
      showMessage(`ì„ íƒëœ ë‚œì´ë„: ${DIFFICULTIES[currentDiffKey].label}`);
    });
  });

  /***** ì „ì²´í™”ë©´ *****/
  function toggleFullscreen() {
    if (!document.fullscreenElement) {
      if (gameWrapper.requestFullscreen) gameWrapper.requestFullscreen();
    } else {
      if (document.exitFullscreen) document.exitFullscreen();
    }
  }
  fullscreenBtn.addEventListener("click", toggleFullscreen);
  document.addEventListener("keydown", (e) => {
    if (e.key === "f" || e.key === "F") toggleFullscreen();
  });

  /***** ê²Œì„ ì‹œì‘ *****/
  startBtn.addEventListener("click", () => {
    startGameWithCountdown();
  });

  function startGameWithCountdown() {
    if (running) return;
    resetGameState();
    countdownEl.classList.remove("hidden");
    let count = 3;
    countdownEl.textContent = count;
    showMessage("ì¤€ë¹„í•˜ì„¸ìš”...");

    countdownTimer && clearInterval(countdownTimer);
    countdownTimer = setInterval(() => {
      count--;
      if (count > 0) {
        countdownEl.textContent = count;
      } else {
        clearInterval(countdownTimer);
        countdownEl.classList.add("hidden");
        startGame();
      }
    }, 1000);
  }

  function resetGameState() {
    cancelAnimationFrame(animationId);
    activeWords.forEach(w => w.el.remove());
    activeWords = [];
    running = false;
    score = 0;
    mistakes = 0;
    lives = MAX_LIVES;
    totalSpawned = 0;
    phraseSlotCounter = 0;
    pauseUntil = 0;
    combo = 0;
    scoreEl.textContent = "0";
    mistakesEl.textContent = "0";
    updateHearts();
    removeGameOverModal();
  }

  function startGame() {
    running = true;
    lastSpawnTime = performance.now();
    lastFrameTime = performance.now();
    typeInput.value = "";
    typeInput.focus();
    showMessage(`ê²Œì„ ì‹œì‘! ë‚œì´ë„: ${DIFFICULTIES[currentDiffKey].label}`);
    animationId = requestAnimationFrame(gameLoop);
  }

  /***** ë©”ì¸ ë£¨í”„ *****/
  function gameLoop(timestamp) {
    if (!running) return;
    const diff = DIFFICULTIES[currentDiffKey];
    const delta = timestamp - lastFrameTime;
    lastFrameTime = timestamp;

    const spawningAllowed = timestamp >= pauseUntil;

    if (spawningAllowed && timestamp - lastSpawnTime >= diff.spawnInterval) {
      spawnWord();
      lastSpawnTime = timestamp;
    }

    const rect = gameContainer.getBoundingClientRect();
    const height = rect.height;
    const mouthY = height * MOUTH_Y_RATIO;
    const maxDropY = height + 40;

    activeWords.forEach(wordObj => {
      wordObj.elapsed += delta;
      const totalDuration = diff.fallDuration;

      let y, x;
      if (wordObj.elapsed <= POP_TIME) {
        // ìœ„ë¡œ + ì˜†ìœ¼ë¡œ ëŒ€ê°ì„  POP
        const t = wordObj.elapsed / POP_TIME; // 0~1
        y = mouthY - POP_HEIGHT * t;
        x = wordObj.startX + (wordObj.targetX - wordObj.startX) * t;
      } else {
        // ì•„ë˜ë¡œ ëŠë¦¬ê²Œ ë‚™í•˜
        const remain = totalDuration - POP_TIME;
        const downElapsed = Math.max(0, wordObj.elapsed - POP_TIME);
        const t = Math.min(downElapsed / remain, 1);
        const startY = mouthY - POP_HEIGHT;
        y = startY + t * (maxDropY - startY);
        x = wordObj.targetX; // ë‚™í•˜ ë•ŒëŠ” x ê³ ì •
      }

      wordObj.y = y;
      wordObj.x = x;
      wordObj.el.style.transform = `translate(${wordObj.x}px, ${wordObj.y}px)`;
    });

    const stillActive = [];
    activeWords.forEach(wordObj => {
      if (wordObj.y > height) {
        registerMistake("ë‹¨ì–´ë¥¼ ë†“ì³¤ì–´ìš” ğŸ˜¢");
        wordObj.el.remove();
      } else {
        stillActive.push(wordObj);
      }
    });
    activeWords = stillActive;

    animationId = requestAnimationFrame(gameLoop);
  }

  /***** ë‹¨ì–´ ìƒì„± (ì…ì—ì„œ ì‹œì‘ â†’ ëŒ€ê°ì„  POP) *****/
  function spawnWord() {
    const diff = DIFFICULTIES[currentDiffKey];
    totalSpawned++;
    phraseSlotCounter = (phraseSlotCounter + 1) % 10; // 0~9

    let text;
    let isSpecial = false;

    const canUsePhrase = diff.usePhrases2 || diff.usePhrases3;
    const isPhraseSlot = canUsePhrase && phraseSlotCounter === 0;

    if (isPhraseSlot) {
      if (diff.usePhrases3 && Math.random() < (diff.special3Chance || 0)) {
        text = randomFrom(PHRASES3);
        isSpecial = true;   // íŠ¹ìˆ˜ë‹¨ì–´ = 3ì–´ì ˆë§Œ
      } else if (diff.usePhrases2) {
        text = randomFrom(PHRASES2);
      } else {
        text = randomFrom(diff.wordPool());
      }
    } else {
      text = randomFrom(diff.wordPool());
    }

    const el = document.createElement("div");
    el.className = "word";
    if (isSpecial) el.classList.add("special");
    el.textContent = text;
    gameContainer.appendChild(el);

    const { width: containerWidth, height } = gameContainer.getBoundingClientRect();
    const mouthX = containerWidth * MOUTH_X_RATIO;
    const mouthY = height * MOUTH_Y_RATIO;

    const baseOffset = 60;
    const jitter = 30;
    const side = Math.random() < 0.5 ? -1 : 1;

    const targetXCenter = mouthX + side * (baseOffset + Math.random() * jitter);
    const targetX = Math.min(
      Math.max(targetXCenter - el.offsetWidth / 2, 0),
      containerWidth - el.offsetWidth
    );

    el.style.transform = `translate(${mouthX - el.offsetWidth / 2}px, ${mouthY}px)`;

    activeWords.push({
      el,
      text,
      startX: mouthX - el.offsetWidth / 2,
      targetX,
      x: mouthX - el.offsetWidth / 2,
      y: mouthY,
      elapsed: 0,
      isSpecial
    });
  }

  function randomFrom(arr) {
    return arr[Math.floor(Math.random() * arr.length)];
  }

  /***** ì…ë ¥ & ì ìˆ˜ (ê¸€ììˆ˜ + ì½¤ë³´) *****/
  typeInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      handleInput();
    }
  });

  function handleInput() {
  if (!running) return;
  const input = typeInput.value.trim();
  if (!input) return;

  let matchedIndex = -1;
  let matchedY = -Infinity;
  let matchedWord = null;

  activeWords.forEach((w, idx) => {
    if (w.text === input && w.y > matchedY) {
      matchedIndex = idx;
      matchedY = w.y;
      matchedWord = w;
    }
  });

  if (matchedIndex !== -1) {
    // âœ… ì •ë‹µ ì²˜ë¦¬ (ê·¸ëŒ€ë¡œ)
    const [matched] = activeWords.splice(matchedIndex, 1);
    matched.el.style.transition = "transform 0.15s ease, opacity 0.15s ease";
    matched.el.style.opacity = "0";
    matched.el.style.transform += " scale(1.1)";
    setTimeout(() => matched.el.remove(), 160);

    const baseChars = matched.text.replace(/\s+/g, "").length;
    combo += 1;
    const comboBonus = Math.max(0, Math.round((combo - 1) * 0.5));
    let gained = baseChars + comboBonus;

    const isSpecial3 = matched.isSpecial || SPECIAL_3_SET.has(matched.text);
    if (isSpecial3 && (currentDiffKey === "youth" || currentDiffKey === "adult")) {
      gained += 3;
    }

    score += gained;
    scoreEl.textContent = String(score);

    if (combo > 1) {
      showMessage(`ì •ë‹µ! +${gained}ì  (ê¸€ì ${baseChars}, ì½¤ë³´ ${combo}íšŒ)`);
    } else {
      showMessage(`ì •ë‹µ! +${gained}ì `);
    }

    if (isSpecial3 && (currentDiffKey === "youth" || currentDiffKey === "adult")) {
      triggerSpecialEffect();
    }
  } else {
    // âœ… ì˜¤íƒ€: ëª©ìˆ¨ ì•ˆ ê¹ì´ê³ , ì½¤ë³´ë§Œ ëŠê¸°ê³  ë©”ì‹œì§€ë§Œ í‘œì‹œ
    combo = 0;
    showMessage("ì˜¤íƒ€ì—ìš” ğŸ˜…");
  }

  typeInput.value = "";
}

  /***** ì‹¤ìˆ˜ ê³µí†µ ì²˜ë¦¬ *****/
  function registerMistake(msg) {
    if (!running) return;
    mistakes++;
    mistakesEl.textContent = String(mistakes);
    combo = 0;
    lives--;
    updateHearts();

    if (lives <= 0) {
      gameOver();
    } else if (msg) {
      showMessage(`${msg} (ë‚¨ì€ ìƒëª…: ${lives})`);
    }
  }

  function updateHearts() {
    let heartsStr = "";
    for (let i = 0; i < lives; i++) heartsStr += "â™¥";
    for (let i = lives; i < MAX_LIVES; i++) heartsStr += "â™¡";
    heartsEl.textContent = heartsStr;
  }

  /***** íŠ¹ìˆ˜ íš¨ê³¼ *****/
  function triggerSpecialEffect() {
    showMessage("íŠ¹ìˆ˜ êµ¬! í™”ë©´ ì •ë¦¬ & ìƒëª… +1 âœ¨");

    flashEl.classList.add("show");
    setTimeout(() => flashEl.classList.remove("show"), 250);

    activeWords.forEach(w => w.el.remove());
    activeWords = [];

    if (lives < MAX_LIVES) {
      lives++;
      updateHearts();
    }
    pauseUntil = performance.now() + 1000;
  }

  /***** ê²Œì„ ì˜¤ë²„ + ì ìˆ˜ ë“±ë¡ *****/
  function gameOver() {
    running = false;
    cancelAnimationFrame(animationId);
    showMessage(`ê²Œì„ ì˜¤ë²„! ìµœì¢… ì ìˆ˜: ${score}ì `);
    showGameOverModal();
  }

  function showGameOverModal() {
    removeGameOverModal();

    const modal = document.createElement("div");
    modal.className = "game-over-modal";
    modal.id = "gameOverModal";
    modal.innerHTML = `
      <div class="game-over-box">
        <h2>ê²Œì„ ì¢…ë£Œ</h2>
        <p>ìµœì¢… ì ìˆ˜: <strong>${score}</strong> ì <br>ë‚œì´ë„: ${DIFFICULTIES[currentDiffKey].label}</p>
        <p style="margin-top:6px;">ë­í‚¹ì— ê¸°ë¡í•  ì´ë¦„ì„ ì ì–´ì£¼ì„¸ìš”.</p>
        <input type="text" id="nameInput" maxlength="10" placeholder="ì´ë¦„ (ìµœëŒ€ 10ì)" />
        <button id="saveScoreBtn">ì ìˆ˜ ì €ì¥</button>
        <button id="noSaveBtn" style="background:#4b5563;margin-top:4px;">ì €ì¥ ì•ˆí•¨</button>
      </div>
    `;
    gameContainer.appendChild(modal);

    const nameInput = modal.querySelector("#nameInput");
    const saveBtn = modal.querySelector("#saveScoreBtn");
    const noSaveBtn = modal.querySelector("#noSaveBtn");

    nameInput.focus();

    saveBtn.addEventListener("click", () => {
      const name = nameInput.value.trim() || "ë¬´ëª…";
      saveScoreToLocalRanking(score, DIFFICULTIES[currentDiffKey].label, name);
      removeGameOverModal();
    });

    noSaveBtn.addEventListener("click", () => {
      removeGameOverModal();
    });

    nameInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        saveBtn.click();
      }
    });
  }

  function removeGameOverModal() {
    const modal = document.getElementById("gameOverModal");
    if (modal) modal.remove();
  }

  /***** ë©”ì‹œì§€ *****/
  function showMessage(text) {
    messageEl.textContent = text;
  }

  /***** ë¡œì»¬ ë­í‚¹ *****/
  const RANK_KEY = "sermon_typer_ranking_v2";

  function loadRanking() {
    try {
      const raw = localStorage.getItem(RANK_KEY);
      if (!raw) return [];
      const parsed = JSON.parse(raw);
      return Array.isArray(parsed) ? parsed : [];
    } catch {
      return [];
    }
  }

  function saveRanking(list) {
    localStorage.setItem(RANK_KEY, JSON.stringify(list));
  }

  function saveScoreToLocalRanking(score, difficultyLabel, name) {
    const list = loadRanking();
    list.push({
      name: name.substring(0, 10),
      score,
      difficulty: difficultyLabel,
      date: new Date().toISOString()
    });

    list.sort((a, b) => {
      if (b.score !== a.score) return b.score - a.score;
      return new Date(b.date) - new Date(a.date);
    });

    const top10 = list.slice(0, 10);
    saveRanking(top10);
    renderRanking();
  }

  function renderRanking() {
    const list = loadRanking();
    rankTableBody.innerHTML = "";
    list.forEach((item, index) => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${item.name}</td>
        <td>${item.score}</td>
        <td>${item.difficulty}</td>
      `;
      rankTableBody.appendChild(tr);
    });
  }

  resetRankBtn.addEventListener("click", () => {
    if (confirm("ì •ë§ë¡œ ë¡œì»¬ ë­í‚¹ì„ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?")) {
      localStorage.removeItem(RANK_KEY);
      renderRanking();
    }
  });

  renderRanking();
  updateHearts();
  showMessage("ë‚œì´ë„ë¥¼ ì„ íƒí•˜ê³  [ê²Œì„ ì‹œì‘] ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.");
</script>
</body>
</html>

